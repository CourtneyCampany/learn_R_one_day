---
title: "Preceeding Drought and Rapid Precipitation Generated Boulder Flood"
author: "Max Israelit"
date: "4/2/2018"
output: 
  word_document:
    reference_docx: manuscriptstyle.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data prep precip, echo=FALSE, message=FALSE, warning=FALSE}
se <- function(x) sd(x)/sqrt(length(x))

library(ggplot2)
library(ggExtra)
library(lubridate)
library(doBy)

precip <- read.csv("data/805333-precip_daily_1948-2013.csv")
precip$DateTime <- as.POSIXct(precip$DATE, format="%Y%m%d %H:%M")
precip$DATE2 <- as.Date(precip$DATE, "%Y%m%d %H:%M")
precip$month <- lubridate::month(precip$DateTime)
precip$year <- lubridate::year(precip$DateTime)
precip2 <- precip[precip$HPCP != 999.99,]

precip_moagg <- doBy::summaryBy(HPCP ~ month, data=precip2, FUN=c(mean, se))
precip_moagg$ylo <- precip_moagg$HPCP.mean - precip_moagg$HPCP.se
precip_moagg$yhi <- precip_moagg$HPCP.mean + precip_moagg$HPCP.se

precip_yagg <- doBy::summaryBy(HPCP ~ year, data=precip2, FUN=c(mean, se))
precip_yagg$ylo <- precip_yagg$HPCP.mean - precip_yagg$HPCP.se
precip_yagg$yhi <- precip_yagg$HPCP.mean + precip_yagg$HPCP.se

precip3 <- precip2[precip2$DateTime > as.POSIXct("20110101 00:00" , format="%Y%m%d %H:%M", tz="GMT"),]
precip3$quarter <- lubridate::round_date(with_tz(precip3$DateTime, tzone="GMT"), unit="quarter")
precip3_qagg <- doBy::summaryBy(HPCP ~ quarter, data=precip3, FUN=c(mean, se))
precip3_qagg$ylo <- precip3_qagg$HPCP.mean - precip3_qagg$HPCP.se
precip3_qagg$yhi <- precip3_qagg$HPCP.mean + precip3_qagg$HPCP.se


```

```{r data prep climate, echo=FALSE, message=FALSE, warning=FALSE}
clim_bc <- read.table("data/climate_co.txt", header = TRUE)
clim_bc <- clim_bc[complete.cases(clim_bc$PDSI),]
clim_bc$Date <- paste(clim_bc$YearMonth, "01", sep="")
clim_bc$Date <- as.Date(clim_bc$Date, format="%Y%m%d")
clim_bc2 <- clim_bc[complete.cases(clim_bc$PDSI),]
clim_bc2$month <- month(clim_bc2$Date)
clim_bc2$quarter <- lubridate::round_date(clim_bc2$Date, unit = "quarter")
clim_bc2$year <- year(clim_bc2$Date)
clim_bc3 <- clim_bc2[clim_bc2$Date > as.Date("20110101", format="%Y%m%d") & clim_bc2$Date < as.Date("20140101", format="%Y%m%d"),]
clim_bc4 <- clim_bc2[clim_bc2$Date > as.Date("20050101", format="%Y%m%d") & clim_bc2$Date < as.Date("20150101", format="%Y%m%d"),]
clim_bc5 <- doBy::summaryBy(PDSI ~ month, data=clim_bc2, FUN=c(mean, se))
clim_bc5$type <- "Average Across All Years"
clim_bc5$yhi <- clim_bc5$PDSI.mean - clim_bc5$PDSI.se
clim_bc5$ylo <- clim_bc5$PDSI.mean + clim_bc5$PDSI.se
clim_bc6 <- doBy::summaryBy(PDSI ~ month, data=clim_bc2[clim_bc2$year == 2013,], FUN=c(mean, se))
clim_bc6$type <- "2013 Average"
clim_bc6$ylo <- 0
clim_bc6$yhi <- 0
clim_bc7 <- rbind(clim_bc5, clim_bc6)
clim_bc7$type <- as.factor(clim_bc7$type)
clim_bc8 <- clim_bc2[clim_bc2$Date > as.Date("20050101", format="%Y%m%d") & clim_bc2$Date < as.Date("20150101", format="%Y%m%d"),]
clim_bc9 <- doBy::summaryBy(ZNDX ~ quarter, data=clim_bc8, FUN=c(mean, se))
clim_bc9$ylo <- clim_bc9$ZNDX.mean - clim_bc9$ZNDX.se
clim_bc9$yhi <- clim_bc9$ZNDX.mean + clim_bc9$ZNDX.se
```

```{r data prep flood, echo=FALSE, message=FALSE, warning=FALSE}
discharge <- read.csv("data/06730200-Discharge_Daily_1986-2013.csv")
discharge$date <- as.Date(discharge$datetime, format="%m/%d/%y")
#must convert cubic feet per second (default for disValue) into cubic feet per meter
discharge$dism <- discharge$disValue * 0.0283
#have to make a nice label for this^ using expression()
dislab <- expression(Stream~Discharge~~(m^3~s^-1))
dis2 <- discharge[discharge$date > as.Date("20130401", format="%Y%m%d") & discharge$date < as.Date("20140101", format="%Y%m%d"),]
```

In early September of 2013, Boulder, CO experienced a severe flooding event lasting for several days. The flooding caused widespread damages, necessitating the evacuation of 11,000 people from nearby counties. According to National Weather Service estimates, this magnitude of heavy rains and subsequent floods was as unlikely as a 1/1000 chance in some areas. Understanding the climactic and regional factors that influenced this flooding event is crucial to developing more resilient and effective flood planning and predicting future threats.

\
#Precipitation
A proximal cause of flooding is heavy precipitation, which can then overcome local watersheds and lead to sharp increases in flow. In order to compare the precipitation leading up to September 2013, we first must explore annual and seasonal patters in the area. Boulder County regularly experiences variation in precipitation by season (Figure 1), which is not uncommon for much of the world. Peak precipitation is generally observed towards the end of the Summer, between July and August. The lowest precipitation levels often occur between January and February, with rainfall gently oscillating between the two extremes.

\
```{r figure 1, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=precip_moagg, aes(x=month, y=HPCP.mean, ymin=ylo, ymax=yhi)) + 
  geom_line() +
  geom_ribbon(alpha=0.5) +
  xlab("Month of Year") +
  ylab("Precipitation (mm)") +
  xlim(c(0,15)) +
  ylim(c(0.045,0.125)) +
  scale_x_continuous(breaks=c(1:12), 
                   labels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec")) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank()) 
```
**Figure 1.** Seasonal variability in precipitation within Boulder County, Colorado, USA. The solid line indicates mean precipitation for that month, whereas the transparent ribbon indicates standard error. Values are taken from daily weather station observations in the area between August 1st, 1948 and December 31st, 2013.

\
In addition to changes in precipitation within a year, the total precipitation amount yearly is also variable. Generally, a trend of increasing yearly rainfall has occurred since 1948 (Figure 2). The most rapid of these increases occurred roughly between 1965 and 1975, with precipitation levels plateauing since. This also indicates that precipitation levels can vary widely between years and that levels the previous year are not necessarily good indicators of coming weather. It is important to note that, at the time of the 2013 floods, precipitation levels were rapidly increasing. Though prior examples of peaks like this are evidenced around 1983, the rapidly increasing rainfall could have played an exacerbating role. Moreover, the existence of a sharp increase and then a plateau in rainfall for this area is reminiscent of a regime shift in biological communities, perhaps indicating that certain environmental changes have forced Boulder County into a different climactic state.

\
```{r figure 2, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=precip_yagg, aes(x=year, y=HPCP.mean, ymin=ylo, ymax=yhi)) + 
  geom_line() +
  geom_ribbon(alpha=0.5) +
  xlab("Date") +
  ylab("Annual Precipitation (mm)")
```
**Figure 2.** Changes in mean annual precipitation by year. The solid line indicates mean precipitation for that year, whereas the transparent ribbon indicates standard error. Values are taken from daily weather station observations in the Boulder County, CO area between August 1st, 1948 and December 31st, 2013.

\
Given these historical patterns of precipitation, we can begin to interpret the precipitation leading up to the 2013 floods. The years leading up to 2013 follow the same seasonal pattern as described above, and peak precipitation levels for those years were consistent with prior years (Figure 3). The flood year itself began similarly to 2011 or 2012, though winter precipitation was slightly lower than usual. Mid-summer months that usually host the most rainfall were similar to 2011 or 2012 as well, but precipitation then drastically increased in the following months, peaking around September and declining afterwards.

\
```{r figure 3, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=precip3_qagg, aes(x=quarter, y=HPCP.mean, ymin=ylo, ymax=yhi)) + 
  geom_line() +
  geom_ribbon(alpha=0.5) +
  xlab("Date (Year)") +
  ylab("Precipitation (mm)")
```
**Figure 3.** Precipitation patterns leading up to the 2013 flood. Precipitation values are calculated on a quarter-yearly basis. The solid line indicates mean precipitation for that year, whereas the transparent ribbon indicates standard error. Values are taken from daily weather station observations in the Boulder County, CO area between January 1st, 2011 and January 1st, 2014.

\
Given these results, it appears that the primary precipitation cause for the flooding was the sharp peak towards the end of 2013. This undoubtedly contributed to the massive surge in flood waters that damaged most of the county, especially given that the peak precipitation levels exceeded any observed in the years leading up to the disaster. Moreover, the trend of increasing precipitation since 1943 could indicate that future flooding may be more frequent. However, precipitation events alone don't explain the entirety of the flood magnitude. For one, previous peaks such as that in 1983 haven't led to similar events despite precipitation averages higher than those in 2013. Moreover, years with lower rainfall levels annually, such as in 1976, have led to even more catastrophic floods (in this case, the Big Thompson Flood). We must consider other climactic factors in order to more fully explore the proximal and distal causes of the 2013 flooding.

\
#Climate
Though precipitation directly influences the water available in case of flooding, precipitation levels are acted on by environmental conditions on the ground. Historic trends of rainfall, for example, don't necessarily indicate drought cycles, as other factors like air temperature must be considered. The Palmer Drought Severity Index (PDSI) is a hydrological index used to measure long-term moisture supply, thereby giving a more accurate picture of existing moisture conditions. When exploring patterns in PDSI leading up to the 2013 flooding, it is clear that the Boulder area was in the process of recovering from a very extreme drought (Figure 4). Values less than zero generally indicate dry spells, while values greater than zero display wet spells. Values exceeding +/- 2 but not +/- 4 indicate moderate magnitudes, while between +/- 4 and +/- 6 indicate severe magnitudes. Thus, it is clear that Boulder had been experiencing extreme drought since early in 2012, and that it was just beginning to recover when the 2013 flooding occurred. 

\
```{r figure 4, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=clim_bc3, aes(x=Date, y=PDSI)) +
  geom_line() +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank()) +
  xlab("Date") +
  ylab("Palmer Drought Severity Index (PDSI)") +
  scale_y_continuous(breaks=c(-6, -4, -2, 0, 2, 4)) +
  geom_vline(xintercept=as.Date("20130915", format="%Y%m%d"), alpha=0.5, size=1.8, col="cornflowerblue")
```
**Figure 4.** Patterns in Palmer Drought Severity Index in Boulder County, CO leading up to the 2013 flooding. Values are calculated on a monthly scale using weather stations from the region. The vertical line indicates the exact date of the floods.

\
This ascertainment is further supported by examining PDSI for numerous years beforehand. When considering index values back to 2005, it becomes evident that the drought period represented more than an annual irregularity (Figure 5). The drought actually began closer to 2010, and was an extended period of low moisture rather than a temporary dip. Moreover, we can see that Boulder County was far from recovering entirely at the time of the flooding. This suggests that the extended period of drought may have exacerbated the precipitation levels observed in late 2013, leading to more torrential flooding than had the area been experiencing a wet spell. A possible mechanism for this is the runoff and erosion control extended by plants to surrounding areas. If vegetation dieback had been common during the drought, or had plant root systems experienced a decline in effectiveness, large precipitation events would be less buffered by the surrounding environment and more would have entered stream networks.

\
```{r figure 5, echo=FALSE, message=FALSE, warning=FALSE}

ggplot(data=clim_bc4, aes(x=Date, y=PDSI)) +
  geom_line() +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank()) +
  xlab("Date") +
  ylab("Palmer Drought Severity Index (PDSI)") +
  scale_y_continuous(breaks=c(-6, -4, -2, 0, 2, 4)) +
  geom_vline(xintercept=as.Date("20130915", format="%Y%m%d"), alpha=0.5, size=1.8, col="cornflowerblue")
```
**Figure 5.** Patterns in Palmer Drought Severity Index in Boulder County, CO leading up to the 2013 flooding. Values are calculated on a monthly scale using weather stations from the region. The vertical line indicates the exact date of the floods.

\
This is further illustrated by comparing the average monthly PDSI in 2013 to that for all other years combined (Figure 6). As is clear by the separation between the two averages, 2013 was more severe of a drought than the average for the previous years. This supports the hypothesis that severe droughts may have led to a decrease in the ability of surrounding lands to retain and limit water flow.

\
```{r figure 6, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=clim_bc7, aes(x=month, y=PDSI.mean, fill=type, color=type, linetype=type, ymin=clim_bc7$ylo, ymax=clim_bc7$yhi)) +
  geom_line(size = 1.5) +
  geom_ribbon(alpha=0.5) +
  scale_y_continuous(breaks=c(-6, -4, -2, 0, 2, 4)) +
  scale_x_continuous(breaks=c(1:12), 
                     labels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec")) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(), legend.position= "top") +
  labs(color="Year", linetype="Year", fill="Year") +
  xlab("Month") +
  ylab("Mean Palmer Drought Severity Index (PDSI)")
```
**Figure 6.** Patterns in mean Palmer Drought Severity Index in 2013 compared to other years. Values are calculated on a monthly scale using weather stations from the region. The solid line indicates mean precipitation for that year, whereas the transparent ribbon indicates standard error. Values are calculated from January 1948 to December 2013.

\
As evidenced by the yearly increase in precipitation since 1948, climatic regimes in the Boulder area are changing. To further illustrate this, we can use the Palmer "Z" Index (ZNDX), which measures departure of each monthly moisture climate value from a historical mean. It shares the same scale as the PDSI, with negative values indicating dry periods and positive values indicating wet periods. From this, we can see that the climate in the first part of 2013 was drier than the historical mean (Figure 7). While the severity of this departure is only moderate, the ZNDX from 2012 was far lower and was extremely drier than historical levels. This is important to keep in mind as climate change projections continue to emerge, as should these dry periods become more frequent, more droughts may loom in the future.

\
```{r figure 7, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=clim_bc9, aes(x=quarter, y=ZNDX.mean, ymin=ylo, ymax=yhi)) +
  geom_line() +
  geom_ribbon(alpha=0.5) +
  xlab("Date") +
  ylab("Palmer Z Index (ZNDX)") +
  scale_x_date(date_labels="%b %Y", limits=c(as.Date("20120101", format="%Y%m%d"), as.Date("20140101", format="%Y%m%d"))) 
```
**Figure 7.** Patterns in mean Palmer Z Index (ZNDX) per quarter year for the Boulder, CO area. The solid line represents the mean ZNDX for that quarter, while the transparent ribbon indicates standard error.

\
#Stream Discharge
Regardless of climactic factors that influence flooding, actual flood damage is often a result of stream discharge. Visualizing patterns of stream discharge can inform flood management practices and damage potential, as well as give indications of how the environment may exacerbate heavy rains. The 2013 flood, which occurred in September, is clearly present as a large spike in stream discharge (Figure 8). Of more interest is the gradual decrease in stream discharge, as compared to the sharp increase at the start of the flood. This indicates that the flood can often come without warning, and very high levels of stream discharge are often characteristic of high flood damages. Nonetheless, the brief period following the flood may continue to experience high discharges, which could lead to further damage, especially if erosion and runoff have altered stream paths.

\
```{r figure 8, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=dis2, aes(x= date, y=disValue)) +
  geom_line() +
  xlab("Date") +
  ylab(dislab) +
  scale_x_date(date_labels="%b %Y")
```
**Figure 8.** Patterns of stream discharge before and after the 2013 flooding events in Boulder, CO. Data was collected on a daily scale.