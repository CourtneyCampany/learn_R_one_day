---
title: "Face Mystery"
author: "Josh Winward"
date: "April 22, 2018"
output: 
  word_document:
    reference_docx: manuscriptstyle.docx
---

```{r setup, include=FALSE, echo=FALSE}
library(ggplot2)
library(lubridate)
library(doBy)
library(reshape2)
se <- function(x) sd(x)/sqrt(length(x))

photo <- read.csv("FACE/data/face_photosynthesis.csv")
photo$Date <- paste(photo$Date, "01", sep="")
photo$Date <- as.Date(photo$Date, format="%b_%Y%d")
photo$quarter <- round_date(photo$Date, unit="quarter")

ambient <- photo[photo$treatment=="aCO2",]
ambient$AnetA <- ambient$Anet
ambient$Anet <- NULL
ambient <- droplevels(ambient)

enriched<- photo[photo$treatment=="eCO2",]
enriched$AnetE <- enriched$Anet
enriched$Anet <- NULL
enriched <- droplevels(enriched)

#lit prep ----------
litter <- read.csv("FACE/data/face_litter.csv")
litter$Date <- as.Date(litter$Date, format="%d/%m/%Y")
litter$year <- as.factor(year(litter$Date))
#must add which treatment belongs to each ring
litter$treatment <- as.factor(ifelse(litter$ring == 2 | litter$ring == 3 | litter$ring == 6, "aCO2", "eCO2"))
#must remove 2 points when big branches fell into litter traps (twig is too big)
#Don't Touch this anymore!!!!!
line.num<-which.max(litter$twig)
litter<-litter[-line.num,]
line.num<-which.max(litter$twig)
litter<-litter[-line.num,]                                      

#need to convert units to g C per year (not g biomass per month as it is now)

basket_size <- .2 #in m2
c_frac <- .47 #conversion to carbon from biomass
litter_carbon <- data.frame(litter[,c(1:3, 8:9)], (litter[,4:7] * c_frac) /  basket_size) # now it's gC m^-2 month^-1
litter_mean_trap <- summaryBy(twig + bark+ seed + leaf ~ year + Date + ring + treatment,
                           data=litter_carbon, FUN=mean, na.rm=TRUE, keep.names = TRUE) #summarizing by averaging all traps
litter_bug <- summaryBy(leaf ~ Date + treatment, data=litter_mean_trap, FUN=mean, keep.names=TRUE, na.rm=TRUE)

litter_annual <- summaryBy(twig + bark + seed + leaf ~ year + ring + treatment, data=litter_mean_trap, FUN=sum, na.rm=TRUE, keep.names = TRUE)

write.csv(litter_annual, "FACE/data/litter_annual.csv", row.names = FALSE)

wood <- read.csv("FACE/data/face_woodbiomass.csv")
ring_diameter <- 25 #ring diameter in m
ring_area <- pi*(ring_diameter/2)^2 #get area
c_frac <- 0.47 #carbon fraction conversion from biomass
kg_to_g <- 1000
total_wood_ring <- summaryBy(biomass_kg ~ year + Ring + treatment, data=wood, FUN=sum, na.rm=TRUE, keep.names=TRUE)
total_wood_ring$Date <- paste(total_wood_ring$year, "/12/31", sep="")
total_wood_ring$Date <- as.Date(total_wood_ring$Date, format = "%Y/%m/%d")
dates <- unique(total_wood_ring$Date)
dates <- dates[order(dates)]
wood_npp <- total_wood_ring[total_wood_ring$Date != dates[1],]
wood_npp$Start_date <- wood_npp$Date #not actually doing anything, just setting the column format up for the FOR Loop
for (i in 1:length(wood_npp$Date)) {
  
  #set start data as the element before 'it' in the date vector. "it" is the date in wood_npp
  wood_npp$Start_date[i] <- dates[which(dates == wood_npp$Date[i]) - 1]  
  #uses our date vector
  
  # finds the previous years biomass for each ring @ right time
  wood_npp$prev_biom_kg[i] <- total_wood_ring$biomass_kg[total_wood_ring$Ring == wood_npp$Ring[i] &
                                                           as.numeric(total_wood_ring$Date-wood_npp$Start_date[i])==0]
}
#unit conversion g per carbon per year per m2
wood_npp$wood_growth <- ((wood_npp$biomass_kg - wood_npp$prev_biom_kg) * c_frac * kg_to_g)/ring_area
#length of period for wood growth (2019-2021 is a problem)
wood_npp$timelength <- as.numeric(wood_npp$Date - wood_npp$Start_date)
wood_npp$wood_yr <- ifelse(wood_npp$timelength == 365, wood_npp$wood_growth/1, wood_npp$wood_growth/2)
#okay that was a pain but now we have annual wood biomass production, let's save it
savewood <- wood_npp[, c(1:3, 5, 10)]
write.csv(savewood, "FACE/data/wood_npp.csv", row.names=FALSE)
```

##Photosynthesis and CO2

The First relationship that is examined in this study is the relationship between photosynthesis activity in ambient CO2 plots vs. enriched CO2 plots. The graph below shows the average values for photosynthesis for both the ambient CO2 treatment and the enriched CO2 treatment over the course of three years. There are seasonal patterns associated with photosynthesis as one might expect. In the summer and spring months the values for photosynthesis are higher than those of the winter months, likely due to the decreased foliage. Additionally, the values for photosynthesis in the enriched group are significantly higher than those of ambient CO2 treatment group. These results indicate that if there is more CO2 in the atmosphere then there will be a concurrent increase in the amount of photosynthesis as compared to a normal concentration of CO2. However, we can also see that as the data progress further in time, the differences in photosynthesis begin to diminish t other point where there is a negligible difference in photosynthetic activity in 2024 when standard error is taken into consideration. The convergence of photosynthetic rates is likely a result of nutrient limitation in the soil. As CO2 is added to the atmosphere, the rates of photosynthesis will increase, however if there is not enough nitrogen in the soil to support the increased photosynthesis, those rates will revert back to baseline as is seen at the end of the data set. 
```{r, echo=FALSE}
photos <- doBy::summaryBy(Anet ~ quarter + treatment, data=photo, FUN=c(mean, se))
photos$ylo <- photos$Anet.mean - photos$Anet.se
photos$yhi <- photos$Anet.mean + photos$Anet.se
anetlab <- expression('A'[net]~(mu~mols~m^-2~s^-1))
ggplot(data=photos, aes(x=quarter, y=Anet.mean, fill=treatment, shape=treatment, ymin=ylo, ymax=yhi)) +
  geom_line() +
  geom_point() +
  geom_ribbon(alpha=0.5) +
  theme_classic() +
  theme(legend.position = "top") +
  labs(fill="Treatment", shape="Treatment") +
  labs(x="Year", y=anetlab)
```

\ Figure 1: Rates of Photosynthesis for both ambient levels of CO2(aCO2) and enriched levels of CO2 (eCO2) from a FACE experiment are plotted over time. The standard error for all points in time is represented by the shaded overlay for each treatment group. Levels of eCO2 are consistently higher than aCO2 throughout the first 3 years, however the values converge towards the end of the experiment. 


##Litterfall and CO2

The second relationship shown is the difference in annual productivity as represented by different litterfall components: twig, bark, seed, and leaf turnover. For all components the amount of carbon in each category is assumed to be 47% Carbon. The rates of litterfall are measured in Grams of Carbon per year per meter squared. The data are shown as a stacked bar-plot with aCO2 for the first four years on the left and data for eCO2 on the right. As we can see there is litter difference between each group in terms of how much carbon is released in the litterfall. If anything there is a slight decrease in the amount of carbon for the enriched CO2 plots in 2021 and 2022. However, there is an increase in the proportion taken up by bark in the enriched CO2 plots. This is likely a result of the fact that plants store carbon as biomass particularly in wood and bark. When there is an increase in the amount of photosynthesis there is an increase in the ability to store carbon, thus there with be an concurrent increase in the amount of woody biomass. Additionally we see that for each group and each year the majority of the carbon in invested in leaf biomass, and that there is a large period of growth between 2020 and 2021. 
```{r, echo=FALSE}
litter_co2 <- summaryBy(twig + bark + seed + leaf ~ year + treatment, data=litter_annual, FUN=mean, keep.names = TRUE)
litter_co2$group <- paste(litter_co2$treatment, litter_co2$year, sep=" ")
litter_co22 <- litter_co2[,3:7]
library(reshape2)
litter_graph <- melt(litter_co22, id.var="group")
litterylab <- expression(~g~C~m^-2~y^-1)
litter_graph$group <- as.factor(litter_graph$group)
levels(litter_graph$group) <- gsub(" ", "\n", levels(litter_graph$group))
ggplot(litter_graph, aes(x=group, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  theme_classic() +
  theme(legend.position = "top") +
  labs(fill="Component") +
  labs(y=litterylab, x="Treatment Group and Year")
```


\ Figure 2: Litter turnover and annual productivity are represented in Grams of carbon per year per meter^2. The relevant components of the litter (Twigs, Bark, Seeds, and Leaves) are stacked to show the relevant proportions of each component. Each column represents one year for one treatment group to show changes in components and total litterfall for each year for each component. ACO2 is shown on the left groups, and EC02 is shown on the right groups. 

## ANPP and CO2 

Total above ground net primary production is shown for both ambient CO2 and enriched CO2. Values of total ANPP are consistently higher than those of the enriched CO2. For ACO2 there is a linear increase in ANPP whereas for ECO2 there is a slow increase between 2021 and 2022, and a more steep increase between 2022 and 2023. This relationship matches up with figure 2 where we see there is a steady increase in ACO2 whereas there is a plateau and then increase for ECO2. These results are incongruous with the photosynthetic data however, while ECO2 has an increased amount of photosynthetic activity, there is a decreased amount of ANPP. This is likely because even through there is an increased amount of photosynthesis, the amount of litter turnover is increased for ECO2, thus there is less above ground storage of Carbon. 
```{r, echo=FALSE}
addwood <- summaryBy(wood_yr ~ year+treatment, data=savewood)
addwood$group <- paste(addwood$treatment, addwood$year, sep=" ")
anpp <- merge(addwood, litter_co22)
anpp$anpp <- anpp$wood_yr.mean + anpp$twig + anpp$bark + anpp$seed + anpp$leaf
ggplot(data=anpp, aes(x=year, y=anpp, color=treatment, shape=treatment)) +
  geom_line() +
  geom_point() +
  theme_classic() +
  theme(legend.position="top") +
  labs(y=expression(ANPP~(g~C~m^-2~year^-1)), x="Year", shape="Treatment", color="Treatment") +
  scale_x_continuous(breaks=c(2021, 2022, 2023))
```


\ Figure 3: ANPP for both ACO2 and ECO2 are shown over the course of three years. ANPP for ACO2 is consistently higher than ECO2 although they appear to be converging in 2023, and values for both eCO2 and ACO2 consistently increase over time. 

##Bugs and CO2

The last relationship which is visualized by this data set is the prevalence of insect outbreaks and defoliage events. These defoliage events are marked by an abnormal increase in the amount of leaf litter accrued. Over the course of this study there seem to have been 4 major defoliage events. The first event occurred at the beginning of 2022, in this event there was an increased amount of defoliage for both the aCO2 and eCO2 groups indicating that there was no effect of CO2 on the amount of defoliage. The second and third events occurred just before and just after 2023. In the first event there was only an increase in litterfall for ACO2 indicating only the ambient group was impacted by the insect outbreak. The reverse is true for the third outbreak however, although this was a more minor outbreak, it seems that the ECO2 group was more impacted than the ACO2 group. Lastly there was another major defoliage event towards the end of 2023. In this case the ACO2 group was more severely impacted than the ECO2 group. Overall there does not seem to be a huge impact of CO2 on the impact of defoliage events by insects. If anything the ACO2 group may be slightly more impacted than the ECO2 group, however both groups experienced and equal number of defoliage events although the ACO2 events seemed to have slightly more severity. 
```{r, echo=FALSE}
buglab <- expression(Leaf~Litter~(g~C~m^-1~month^-1))
ggplot(data=litter_bug, aes(x=Date, y=leaf, color=treatment, shape=treatment)) +
  geom_line() +
  geom_point() +
  theme_classic() +
  theme(legend.position = "top") +
  labs(x="Year", y=buglab, shape="Treatment", color="Treatment") +
  geom_vline(xintercept=as.Date("20220115", format="%Y%m%d"), alpha=0.25) +
  geom_vline(xintercept=as.Date("20221015", format="%Y%m%d"), alpha=0.25) +
  geom_vline(xintercept=as.Date("20230315", format="%Y%m%d"), alpha=0.25) +
  geom_vline(xintercept=as.Date("20231015", format="%Y%m%d"), alpha=0.25)
```


\ Figure 4: Defoliation events are represented by spikes in leaf litter turnover. Data for both A and E CO2 are represented (Red = ACO2, Blue = ECO2). The defoliation events are marked by a spike in leaf litter turnover and are indicated on the graph by a spike in the leaf litter and a vertical line marking the peak. 
